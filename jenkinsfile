pipeline{
    agent none
    stages{
        stage('gitclone'){
            agent any
            steps{
                git credentialsId: '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', url: 'https://github.com/roshanbarkuntwar/hello-world.git'
            }
        }
        stage('compile'){
            agent any
            steps{
                sh 'mvn compile'
            }
        }
        stage('test'){
            agent any
            steps{
                sh 'mvn test'
            }
        }
        stage('package'){
            agent any
            steps{
                sh 'mvn package'
            }
        } 
        stage ('deploy') {
      steps {
        script {
          deploy adapters: [tomcat9(credentialsId: 'tomcat_credential', path: '', url: 'http://localhost:8090/')], contextPath: '/pipeline', onFailure: false, war: 'webapp/target/*.war' 
            }
         }   
        stage('deploy'){
            agent any
            steps{
                sh label: '', script: '''rm -rf dockerimg
mkdir dockerimg
cd dockerimg
cp /var/jenkins_home/workspace/demo/webapp/target/*.war .
touch dockerfile
cat <<EOT>>dockerfile
FROM tomcat
ADD webapp.war /usr/local/tomcat/webapps/
CMD ["catalina.sh", "run"]
EXPOSE 8080
EOT
docker build -t webimage:$BUILD_NUMBER .
docker login -u roshanbarkuntwar -p Roshan@12345
docker tag webimage:$BUILD_NUMBER roshanbarkuntwar/tomcat:$BUILD_NUMBER
docker push roshanbarkuntwar/tomcat:$BUILD_NUMBER
#sudo docker container run -itd --name webserver$BUILD_NUMBER -p 8080 webimage:$BUILD_NUMBER'''
             }
          }
       }
    }
}
